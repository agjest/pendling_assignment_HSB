---
title: "assignment_3"
format: html
editor: visual
---

# Pendlemønster på Haugalandet

**MSB 105 - Data Science\
Gruppe 4: Hanna Sundal Bjerkreim & Elvar Solheim**

```{r}
#| label: setup
#| echo: false
#| output: false
#| message: false
library(tidyverse)
library(tidyselect)
library(lubridate)
library(PxWebApiData)
library(flextable)
```

I denne oppgaven skal vi studere pendlemønsteret på Haugalandet i perioden 2000 t.o.m. 2022.
Haugalandet inkluderer følgende kommuner: Haugesund, Karmøy, Tysvær, Sveio, Bokn, Vindafjord, Sauda og Etne.
Vi skal presentere utviklingen i jobbpendling over tid for de ulike kommunene ved hjelp av plots.
Vi skal også presentere noen pendlematriser.

Videre i oppgaven skal vi også se nærmere på hvordan T-sambandet som åpnet i 2013 og avviklingen av bompengeinnkreving i 2021 påvirket pendlemønsteret mellom kommunene Haugesund, Karmøy, Tysvær og Bokn.

## Datamanipulering

Dataene i oppgaven er hentet fra SSB sin statistikktabell 03321, "*Sysselsatte (15-74 år), etter arbeidssteds- og bostedskommune. Pendlingsstrømmer. 4. kvartal (K) 2000-2022*".
Etter litt datamanipulering satt vi igjen med ett datasett på 1840 observasjoner fordelt på 6 variabler: år, bokommune, arbeidskommune, pendlere, boprosent, arbeidsprosent.

```{r}
knr <- c("1106", "1135", "1145", "1146", "1149"
                ,"1154", "1159", "1160", "4611", "4612", 
                "1211", "1216")
```

```{r}
# Bosteds-kommuner
pend_00_22_ssb_boHland <- ApiData12(
  urlToData = "https://data.ssb.no/api/v0/no/table/03321/", 
  ArbstedKomm = list('*'),
  Bokommuen = c("1106", "1135", "1145", "1146", 
                  "1149","1154", "1159", "1160", 
                  "4611", "4612", "1211", "1216"),
  Tid = as.character(2000:2022)
  )
```

```{r}
# Arbeidssted-kommuner
pend_00_22_ssb_arbHland <- ApiData12(
  urlToData = "https://data.ssb.no/api/v0/no/table/03321/",
  ArbstedKomm = c("1106", "1135", "1145", "1146", 
                  "1149","1154", "1159", "1160", 
                  "4611", "4612", "1211", "1216"),
  Bokommuen = list('*'),
  Tid = as.character(2000:2022)
  ) 
```

```{r}
# Redusert versjon av bosteds-kommuner (pend_00_22_ssb_boHland)
pend_00_22_boHland <- pend_00_22_ssb_boHland |>
  select(
    aar = år, 
    bo_kom = bostedskommune, 
    arb_kom = arbeidsstedskommune,  
    pendlere = value
  )
```

```{r}
# Redusert versjon av arbeidssted-kommuner (pend_00_22_ssb_arbHland)
pend_00_22_arbHland <- pend_00_22_ssb_arbHland |>
  select(
    aar = år, 
    arb_kom = arbeidsstedskommune, 
    bo_kom = bostedskommune, 
    pendlere = value
  )
```

```{r}
# AG: Se under for kanskje en litt enklere løsning som er
# mer i tidyverse sin ånd
# Konventere bo_kom og arb_kom til kategorivariabler
# pend_00_22_boHland$bo_kom <- as_factor(pend_00_22_boHland$bo_kom)
# pend_00_22_boHland$arb_kom <- as_factor(pend_00_22_boHland$arb_kom)
# pend_00_22_arbHland$bo_kom <- as_factor(pend_00_22_arbHland$bo_kom)
# pend_00_22_arbHland$arb_kom <- as_factor(pend_00_22_arbHland$arb_kom)
```

```{r}
pend_00_22_boHland <- pend_00_22_boHland |> 
  mutate(
    # as_factor() kan brukes istedenfor fct(). as_factor() litt raskere,
    # men også litt mer risky i noen tilfeller. Her tror jeg de to
    # er like raske og gir samme resultat
    bo_kom = fct(bo_kom),
    arb_kom = fct(arb_kom)
  )
```

```{r}
pend_00_22_arbHland <- pend_00_22_arbHland |>
  mutate(
    bo_kom = fct(bo_kom),
    arb_kom = fct(arb_kom)
  )
```

```{r}
# AG: Foreslår kollaps av både bo_kom og arb_kom i en pipe
# Kollapse faktornivåer for bostedskommuner
pend_00_22_boHland <- pend_00_22_boHland |>
  mutate(
    # Kollapse faktornivåer i bo_kom for bostedskommuner
    bo_kom = fct_collapse(
    .f = bo_kom,
    "Haugesund" = "Haugesund",
    "Sauda" = "Sauda",
    "Bokn" = "Bokn",
    "Tysvær" = "Tysvær",
    "Karmøy" = "Karmøy",
    "Vindafjord" = c("Vindafjord", "Vindafjord (1965-2005)", 
                     "Ølen (2002-2005)"),
    "Etne" = c("Etne", "Etne (-2019)"),
    "Sveio" = c("Sveio", "Sveio (-2019)"),
    # AG: samler alle resterende kommuner i en kategori "Andre"
    other_level = "Andre"
    ),
    # Kollapse faktornivåer i arb_kom for bosteds-kommuner
    arb_kom = fct_collapse(
    .f = arb_kom,
    "Haugesund" = "Haugesund",
    "Sauda" = "Sauda",
    "Bokn" = "Bokn",
    "Tysvær" = "Tysvær",
    "Karmøy" = "Karmøy",
    "Vindafjord" = c("Vindafjord", "Vindafjord (1965-2005)", 
                     "Ølen (2002-2005)"),
    "Etne" = c("Etne", "Etne (-2019)"),
    "Sveio" = c("Sveio", "Sveio (-2019)"),
    other_level = "Andre"
    )
  )
```

```{r}
# AG: Foreslår kollaps av både bo_kom og arb_kom i en pipe
# Kollapse faktornivåer for arbeidssted-kommuner
pend_00_22_arbHland <- pend_00_22_arbHland |>
  mutate(
    # Kollapse faktornivåer i bo_kom for arbeidssted-kommuner
    bo_kom = fct_collapse(
    .f = bo_kom,
    "Haugesund" = "Haugesund",
    "Sauda" = "Sauda",
    "Bokn" = "Bokn",
    "Tysvær" = "Tysvær",
    "Karmøy" = "Karmøy",
    "Vindafjord" = c("Vindafjord", "Vindafjord (1965-2005)", 
                     "Ølen (2002-2005)"),
    "Etne" = c("Etne", "Etne (-2019)"),
    "Sveio" = c("Sveio", "Sveio (-2019)"),
    other_level = "Andre"
    ),
    arb_kom = fct_collapse(
    .f = arb_kom,
    "Haugesund" = "Haugesund",
    "Sauda" = "Sauda",
    "Bokn" = "Bokn",
    "Tysvær" = "Tysvær",
    "Karmøy" = "Karmøy",
    "Vindafjord" = c("Vindafjord", "Vindafjord (1965-2005)", 
                     "Ølen (2002-2005)"),
    "Etne" = c("Etne", "Etne (-2019)"),
    "Sveio" = c("Sveio", "Sveio (-2019)"),
    other_level = "Andre"
    )
  )
```

```{r}
# eval: false
pend_00_22_boHland <- pend_00_22_boHland |>
  group_by(aar, arb_kom, bo_kom) |>
  summarise(pendlere = sum(pendlere), .groups = "drop")
```

```{r}
# eval: false
pend_00_22_arbHland <- pend_00_22_arbHland |>
  group_by(aar, bo_kom, arb_kom) |>
  summarise(pendlere = sum(pendlere), .groups = "drop")
```

```{r}
# Join datasett for bosteds-kommuner med datasett for arbeidssted-kommuner
pmat_long <- pend_00_22_boHland |>
  full_join(pend_00_22_arbHland, join_by(aar, bo_kom, arb_kom, pendlere)) |>
  ungroup()
```

```{r}
pmat_long$bo_kom <- as.character(pmat_long$bo_kom)
pmat_long$arb_kom <- as.character(pmat_long$arb_kom)
```

```{r}
# Ny variabel bo_percent
pmat_long <- pmat_long |>
  group_by(aar, bo_kom) |>
  mutate(bo_percent = round((pendlere / sum(pendlere)) * 100, 1)) |>
  ungroup()
```

```{r}
# Ny variabel arb_percent
pmat_long <- pmat_long |>
  ungroup() |>
  group_by(aar, arb_kom) |>
  mutate(arb_percent = round((pendlere / sum(pendlere)) * 100, 1)) |>
  ungroup()
```

```{r}
pmat_long <- pmat_long |>
  ungroup() |>
  arrange(aar, arb_kom, bo_kom) |>
  select(aar, bo_kom, arb_kom, pendlere, bo_percent, arb_percent)
```

```{r}
# Clean up
rm(pend_00_22_ssb_boHland, pend_00_22_ssb_arbHland, pend_00_22_boHland, pend_00_22_arbHland)
```

## Pendlematriser

Vi skal presentere pendlemønster på Haugalandet ved hjelp av ulike pendlematriser.

@tbl-p2000 er en pendlematrise for Haugalandet for år 2000.

```{r}
#| echo: false
ordKom <- c("bo_kom" , "Haugesund", "Karmøy", "Tysvær", "Sveio", 
            "Bokn", "Vindafjord", "Sauda", "Etne", "Andre")
```

```{r}
#| echo: false
# Pendlematrise for Haugalandet for år 2000
p2000 <- pmat_long |>
  filter(
    aar == "2000"
    ) |>
  # AG: velger pendler, utelater andeler
  select(bo_kom, arb_kom, pendlere) |> 
  pivot_wider(
    names_from = arb_kom, 
    values_from = pendlere
    ) |>
  arrange(
    fct(
      # Må her fjerne første fra ordKom
      bo_kom, levels = ordKom[-1]
      )
    ) |>
  select(
    bo_kom , Haugesund, Karmøy, Tysvær, Sveio, Bokn, Vindafjord, Sauda, Etne, Andre
    ) |>
  rename(
    "Bo kom.\\ Arb. kom" = bo_kom
    )
```

SJEKKET NED HIT.
p2000 ER NÅ IDENTISK LIK MIN. DET PLEIER Å VÆRE ET GODT TEGN.

DERE SKRIVER KLAR OG FIN KODE. PROBLEMET VAR I HOVEDSAK MANGLENDE other_level = "Andre" I fct_collapse.

```{r}
#| echo: false
#| label: tbl-p2000
#| tbl-cap: "Pendlematrise for Haugalandet år 2000."
p2000 |> 
  flextable() |> 
  # a4 8.268 in - 1 in left margin - 1 in right margin = 6.268 in
  fit_to_width(max_width = 6.268, inc = 1L, max_iter = 20, unit = "in") |> 
  line_spacing(space = 0,
              part = "body"
              ) %>% 
  hrule(rule = "exact")  %>% 
  height_all(height = 5, part = "all", unit = "mm") |> 
  padding(padding.top = 1, padding.bottom = 2, part = "all") %>% 
  theme_booktabs()
```

@tbl-p2000_arb_percent er en pendlematrise for dem som *bor* på Haugalandet og viser andelen som jobber i de ulike kommunene.

```{r}
#| echo: false
# Pendlematrise for Haugalandet år 2000 - Bokommune og arbeidsprosent
p2000_arb_percent <- pmat_long |>
  filter(
    aar == "2000"
    ) |>
  pivot_wider(
    names_from = arb_kom, 
    values_from = arb_percent
    ) |>
  arrange(
    fct(
      bo_kom, levels = ordKom
      )
    ) |>
  select(
    bo_kom , Haugesund, Karmøy, Tysvær, Sveio, Bokn, Vindafjord, Sauda, Etne, Andre
    ) |>
  rename(
    "Bo kom.\\ Arb. prosent" = bo_kom
    )
```

```{r}
#| echo: false
#| label: tbl-p2000_arb_percent
#| tbl-cap: "Pendlematrise for Haugalandet år 2000 - Bokommune og arbeidsprosent"
p2000_arb_percent |> 
  flextable() |> 
  # a4 8.268 in - 1 in left margin - 1 in right margin = 6.268 in
  fit_to_width(max_width = 6.268, inc = 1L, max_iter = 20, unit = "in") |> 
  line_spacing(space = 0,
              part = "body"
              ) %>% 
  hrule(rule = "exact")  %>% 
  height_all(height = 5, part = "all", unit = "mm") |> 
  padding(padding.top = 1, padding.bottom = 2, part = "all") %>% 
  theme_booktabs()
```

@tbl-p2000_bo_percent er en pendlematrise for dem som *arbeider* på Haugalandet og viser andelen som bor i de ulike kommunene.

```{r}
#| echo: false
# Pendlematrise for Haugalandet 2000 - Arbeidskommune og boprosent
p2000_bo_percent <- pmat_long |>
  filter(
    aar == "2000"
    ) |>
  pivot_wider(
    names_from = bo_kom, 
    values_from = bo_percent
    ) |>
  arrange(
    fct(
      arb_kom, levels = ordKom
      )
    ) |>
  select(
    arb_kom , Haugesund, Karmøy, Tysvær, Sveio, Bokn, Vindafjord, Sauda, Etne, Andre
    ) |>
  rename(
    "Arb. kom.\\ Bo. prosent" = arb_kom
    )
```

```{r}
#| echo: false
#| label: tbl-p2000_bo_percent
#| tbl-cap: "Pendlematrise for Haugalandet år 2000 - Arbeidskommune og boprosent"
p2000_bo_percent |> 
  flextable() |> 
  # a4 8.268 in - 1 in left margin - 1 in right margin = 6.268 in
  fit_to_width(max_width = 6.268, inc = 1L, max_iter = 20, unit = "in") |> 
  line_spacing(space = 0,
              part = "body"
              ) %>% 
  hrule(rule = "exact")  %>% 
  height_all(height = 5, part = "all", unit = "mm") |> 
  padding(padding.top = 1, padding.bottom = 2, part = "all") %>% 
  theme_booktabs()
```

## Spørsmål

### Spørsmål vedrørende pendle/andels-matrisene for 2000

1.  Hvor mange pendlet fra Haugesund til Vindafjord?

2.  Hvor mange pendlet fra Bokn til Sveio?

3.  Hvor stor andel av arbeidstakerene som bodde i Karmøy kommune i 2000 jobbet i Bokn kommune?

4.  Hvor stor andel av arbeidstakerene som bodde i Bokn kommune i 2000 jobbet i Karmøy kommune?

5.  Hvor stor andel av arbeidstakerne som jobbet i Sveio i 2000 bodde i Haugesund kommune?

6.  Hvor stor andel av arbeidstakerne som jobbet i Sveio i 2000 bodde i Tysvær kommune?

7.  Hvor stor andel av arbeidstakerne som jobbet i Haugesund i 2000 bodde i Vindafjord kommune?

### Spørsmål vedrørende pendle/andels-matrisene for 2012

Lag tilsvarende tre tabeller for 2012

1.  Hvor mange pendlet fra Tysvær til Karmøy?

2.  Hvor mange pendlet fra Karmøy til Tysvær?

3.  Hvor mange pendlet fra Bokn til Karmøy?

4.  Hvor mange pendlet fra Karmøy til Bokn?

5.  Hvor mange pendlet fra Haugesund til Karmøy?

6.  Hvor mange pendlet fra Karmøy til Haugesund?

7.  Hvor stor andel av arbeidstakerene som bodde i Sveio kommune i 2012 jobbet i Tysvær kommune?

8.  Hvor stor andel av arbeidstakerene som bodde i Tysvær kommune i 2012 jobbet i Karmøy kommune?

9.  Hvor stor andel av arbeidstakerne som jobbet i Karmøy i 20112bodde i Haugesund kommune?

10. Hvor stor andel av arbeidstakerne som jobbet i Haugesund i 2012 bodde i Karmøy kommune?

### Spørsmål vedrørende pendle/andels-matrisene for 2022

Lag tilsvarende tre tabeller for 2022.

1.  Hvor mange pendlet fra Tysvær til Karmøy?

2.  Hvor mange pendlet fra Karmøy til Tysvær?

3.  Hvor mange pendlet fra Bokn til Karmøy?

4.  Hvor mange pendlet fra Karmøy til Bokn?

5.  Hvor mange pendlet fra Haugesund til Karmøy?

6.  Hvor mange pendlet fra Karmøy til Haugesund?

7.  Hvor stor andel av arbeidstakerne som jobbet i Karmøy i 2011 bodde i Haugesund kommune?

8.  Hvor stor andel av arbeidstakerne som jobbet i Haugesund i 2011 bodde i Karmøy kommune?

## Plots

## T-sambandet og avvikling av bompengeinnkreving
